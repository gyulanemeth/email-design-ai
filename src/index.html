<html>
  <head>
    <style>
      #left {
        width: 50%;
        float: left;
      }
      #right {
        width: 50%;
        float: right;
      }
      #thumbnail {
        width: 800px;
        height: 1400px;
        border: 1px solid #000;
        margin: 20px auto;
        display: none;
      }
      #loading {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="left">
      <p>
        What should I do?
      </p>
      <div>
        <textarea id="prompt"></textarea>
      </div>
      <button id="execute-prompt">Do it already!</button>
      <div id="loading">loading...</div>
    </div>
    <div id="right">
      <div id="thumbnail" style="margin: 20px auto;"></div>
    </div>
    <script src='https://cdn.chamaileon.io/sdk/1.1.3/umd/plugins.js'></script>
    <script>
      (async function() {
        const initChamaileonSdk = await import('./initChamaileonSdk.js')
        const exampleJson = await import('./exampleJson.js')
        const emailDesignAssistant = await import('./assistant.js')
        const chamaileonPlugins = await initChamaileonSdk.default()

        const thumbnail = document.getElementById('thumbnail')
        thumbnail.style.display = 'block'

        thumbnail.innerHTML = ''
        
        let currentParams = {
            "attrs": {
                "sizeType": "FIT_TO_TEXT",
                "href": "",
                "text": "<p>BUY ME</p>\n",
                "fullWidthOnMobile": false,
                "align": "center"
            },
            "style": {
                "line-height": "24px",
                "color": "#ffffff",
                "font-size": "17px",
                "font-family": "Arial, Helvetica Neue, Helvetica, sans-serif",
                "background-color": "#FF6347",
                "background-position": "center center",
                "background-repeat": "no-repeat",
                "background-image": "url()",
                "border-radius": "5px",
                "border-left": "0px solid #000000",
                "border-bottom": "0px solid #000000",
                "border-right": "0px solid #000000",
                "border-top": "0px solid #000000",
                "margin-left": "10px",
                "margin-bottom": "20px",
                "margin-right": "10px",
                "margin-top": "20px",
                "padding-left": "20px",
                "padding-bottom": "10px",
                "padding-right": "20px",
                "padding-top": "10px",
                "letter-spacing": "normal"
            }
        }

        const documentJson = exampleJson.default(currentParams)

        const thumbnailPlugin = await chamaileonPlugins.createInlinePlugin({
          plugin: 'thumbnail',
          data: { document: documentJson },
          settings: {
            scroll: true
          }
        }, {
          container: thumbnail,
          dimensions: {
            width: 800,
            height: 1400,
            scale: 1,
          }
        })

        document.getElementById('execute-prompt').addEventListener('click', async () => {
          document.getElementById('loading').style.display = 'block'
          document.getElementById('execute-prompt').style.display = 'none'
          document.getElementById('prompt').style.display = 'none'
          const prompt = document.getElementById('prompt').value

          const response = await emailDesignAssistant.default(currentParams, prompt)

          const newParams = JSON.parse(response)
          currentParams = newParams
          const newDocumentJson = exampleJson.default(currentParams)
          await thumbnailPlugin.methods.updateData({ document: newDocumentJson })
          document.getElementById('loading').style.display = 'none'
          document.getElementById('execute-prompt').style.display = 'block'
          document.getElementById('prompt').value = ''
          document.getElementById('prompt').style.display = 'block'
        })
      }())
    </script>
  </body>
</html>
